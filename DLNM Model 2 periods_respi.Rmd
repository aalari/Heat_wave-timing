---
title: "Effect of different Heat wave timing on respiratory mortality in France with DLNM"
author: "Anna Alari and Noemie Letellier"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: html_document

---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,warning = FALSE)
```


```{r, echo=FALSE, warning = FALSE, message=FALSE}
library(xlsx)
library(Hmisc)
library(lubridate)
library(effects)
library(ggplot2)
library(prettyR)
#library(mgcv)
#library(jtools)
#library(broom)
library(segmented)
library(splines)
library(mgcViz)
library(ggeffects)
library(devtools)
library(zoo)
#library(grid)
library(mvmeta)
library(dlnm)
library(knitr)
library(kableExtra)
library(tidyverse)
#library(R2jags)
#library(rjags)
library("writexl")
library(metafor)
library(forestplot)
library("writexl")
library(hrbrthemes)
library(tidyverse)
library(ggridges)
library(viridis)
library(ggpubr)
library(R.utils)
library(meta)
library(jtools)
library(huxtable)

load("C:/Users/aalari/Dropbox/Noemie/FInal Analysis - SpF + CepiDC/villes_s.RData")

```

The aim of the following analysis is to use Distributed Lag Non Linear Models (DLNMs) to estimate the Exposure–Response associations between temperature (maximal and minimum) and mortality during the different months of the summer.

We use DLNMs in order to represent the exposure–response function *f(x)* through a bi-dimensional cross-basis term, which uses flexible natural cubic spline functions to model both exposure–response and lagged-response dimensions. Indeed, we expected to observe a nonlinear temperature–mortality relationship, with increases in relative risk (RR) above and below the minimum mortality temperature (Tmm) that correspond to heat and cold associations, respectively. At the same time, risks are distributed differently across time, with immediate heat-mortality and more delayed cold-mortality associations.

## 1. Estimation of the exposure-response associations for each city during summer months

### Defintion of the cross-basis function for the temperature, with two dimensions:

1. exposure–response dimension "argvar": fitted by a cubic natural spline with three internal knots in the 10th, 75th, 90th percentiles of the temperature distribution
2. lagged-response dimension "arglag": fitted by a cubic natural spline with three internal knots equally-spaced in the log-scale.

```{r}
# 1. SPECIFICATION PARAMETERS OF THE EXPOSURE-RESPONSE DIMENSION OF THE CROSS-BASIS

argvar<-list()

for (i in 1: length(villes_s)){
argvar[[i]] <- list(fun="ns", knots = quantile(villes_s[[i]]$tempmoy,c(10,75,90)/100, na.rm=T),
  Bound=range(villes_s[[i]]$tempmoy,na.rm=T))
}

names(argvar)<-names(villes_s)

# 2. SPECIFICATION PARAMETERS OF THE LAG-ASSOCIATION DIMENSION OF THE CROSS-BASIS
# Definition of the maximum lag, that is, 21 days
maxlag <- 10

arglag <- list(fun="ns",knots=logknots(maxlag,nk=3))

# - CREATE CROSSBASIS OBJECTS
cb<-list()

for (i in 1: length(villes_s)){
cb[[i]] <- crossbasis(villes_s[[i]]$tempmoy,maxlag,argvar[[i]],arglag, group=villes_s[[i]]$year)  
  }

names(cb)<-names(villes_s)
```

#### Fit the models
Include in the models the crossbasis term of temperature, along with the indicator for day of the week (Jours), bank holidays (Vacances) and the year (annee).

```{r}
mod<-list()

for (i in 1: length(villes_s)){
cb_func<-cb[[i]]
mod[[i]] <- glm(respi_tot ~ cb_func + Jours + Vacances + ns(day, 4) + ns(time,3), 
  data=villes_s[[i]], family=quasipoisson)
}

names(mod)<-names(villes_s)
```

#### GET PREDICTIONS & PLOTs
```{r}
# DEFINE CENTERING POINT to More Frequent Temperature (Median Value of temperature) TO OBTAIN PREDICTION
#    NB: 'varcen' is initially set to a provisional temperature value within the observed range. 

mft <-lapply(villes_s,function(x){median(x$tempmoy,na.rm=TRUE)}) 
```

<p>&nbsp;</p>


```{r}
pred<-list()

for (i in 1: length(villes_s)){
  cb_func<-cb[[i]]
pred[[i]] <- crosspred(cb_func, mod[[i]], cen=mft[[i]], from=floor(min(villes_s[[i]]$tempmoy,na.rm=TRUE)), to=floor(max(villes_s[[i]]$tempmoy,na.rm=TRUE)), by=1)
}
names(pred)<-names(villes_s)


```

#### Attributable mortality 

```{r}
## Save RR estimation and compute the heat attributable fraction (HAF)
est<-list()
for (i in 1: length(villes_s)){
  est[[i]] <- data.frame(temp=names(pred[[i]]$allRRfit),RR=pred[[i]]$allRRfit)
  est[[i]]$haf<-(est[[i]]$RR-1)/est[[i]]$RR
  }
names(est)<-names(villes_s)

## Add frequency of the exposure
for (i in 1: length(villes_s)){
  inf<-hist(villes_s[[i]]$tempmoy,xlim=c(round(min(villes_s[[i]]$tempmoy,na.rm=TRUE)), max(villes_s[[i]]$tempmoy,na.rm=TRUE)),breaks = nrow(est[[i]]))
  est[[i]]$count<-inf$counts
  }

## Save the mean mortality value for each city
mean_mort<-lapply(villes_s,function(x){mean(x$respi_tot,na.rm=TRUE)})

## Compute the mortality attributable to heat (MAH) for each temperature value 
for (i in 1: length(villes_s)){
  for (r in 1:nrow(est[[i]])){
  est[[i]]$MAH[r]<-if (est[[i]]$haf[r]>0) {round(est[[i]]$haf[r]*mean_mort[[i]]*est[[i]]$count[r])} else 0
  }
}

```

### PLOT 1 - 3D Exposure-lag-response

```{r, echo = FALSE}
xlab <- expression(paste("Temperature (",degree,"C)"))

layout(matrix(c(1,2,3,4,5,6),ncol=3,nrow=2,byrow=T))
for (i in 1:6){
par(mar=c(2,3,3,1),mgp=c(3,1,0),las=1,cex.axis=0.9,cex.lab=1)
plot(pred[[i]],"3d",ltheta=150,xlab="Temperature (C)",ylab="Lag",zlab="RR", 
  col=gray(0.9), main=names(villes_s)[i])
}
layout(matrix(c(1,2,3,4,5,6),ncol=3,nrow=2,byrow=T))
for (i in 7:12){
par(mar=c(2,3,3,1),mgp=c(3,1,0),las=1,cex.axis=0.9,cex.lab=1)
plot(pred[[i]],"3d",ltheta=150,xlab="Temperature (C)",ylab="Lag",zlab="RR", 
col=gray(0.9), main=names(villes_s)[i])
}
layout(matrix(c(1,2,3,4,5,6),ncol=3,nrow=2,byrow=T))
for (i in 13:18){
par(mar=c(2,3,3,1),mgp=c(3,1,0),las=1,cex.axis=0.9,cex.lab=1)
plot(pred[[i]],"3d",ltheta=150,xlab="Temperature (C)",ylab="Lag",zlab="RR", 
col=gray(0.9), main=names(villes_s)[i])
}
layout(matrix(c(1,2,3,4,5,6),ncol=3,nrow=2,byrow=T))
for (i in 19:21){
par(mar=c(2,3,3,1),mgp=c(3,1,0),las=1,cex.axis=0.9,cex.lab=1)
plot(pred[[i]],"3d",ltheta=150,xlab="Temperature (C)",ylab="Lag",zlab="RR", 
col=gray(0.9), main=names(villes_s)[i])
}

```

### PLOT 2 - OVERALL
The plots show the cumulative exposure-response association, in terms of relative risks (RR) and centered in the mft (solid line in blue), across the 21 days of lag.


```{r, echo = FALSE}
layout(matrix(1:8,ncol=2),heights=c(0.8,rep(0.2,2),0.20,0.8,rep(0.2,2),0.20))
for (i in 1:2){
par(mar=c(0.2,5,2,1),las=1,cex.axis=0.8,cex.lab=1)
plot(pred[[i]],"overall",col="red",xlim=c(min(as.numeric(as.character(est[[i]]$temp))),max(as.numeric(as.character(est[[i]]$temp)))+1),ylim=c(0.5,2.5),axes=F,xlab="", ylab="RR",main=names(villes_s)[i])
abline(v=mft[i],lty=1, col="blue")
abline(v=quantile(villes_s[[i]]$tempmoy,c(0.1,0.75,0.90)),lty=2)
axis(2,at=c(0,round(max(pred[[i]]$allRRfit)*(1/5),digits =2),round(max(pred[[i]]$allRRfit)*(2/5),digits=2),round(max(pred[[i]]$allRRfit)*(3/5),digits = 2),round(max(pred[[i]]$allRRfit)*(4/5),digits=2),round(max(pred[[i]]$allRRfit),digits=2),2))
par(mar=c(0.1,5,0.3,1))
hist(villes_s[[i]]$tempmoy,axes=F,col=grey(0.95),ylab="temp\nfrequency",main="",breaks=nrow(est[[i]]))
abline(v=mft[i],lty=1, col="blue")
abline(v=quantile(villes_s[[i]]$tempmoy,c(0.1,0.75,0.90)),lty=2)
axis(2,at=0:4*100)
par(mar=c(0.1,5,0.2,1))
barplot(height=est[[i]]$MAH,names=est[[i]]$temp,space=0,ylim=c(0,max(est[[i]]$MAH)),ylab="number\nof death",axes=FALSE,axisnames=FALSE,col=grey(0.95))
axis(2,at=c(0,round(max(est[[i]]$MAH)/3),round(max(est[[i]]$MAH)/2),round(max(est[[i]]$MAH)*(2/3)),max(est[[i]]$MAH)))
par(mar=c(4,5,0,1))
plot(pred[[i]]$predvar,rep(0,length(pred[[i]]$predvar)),xlim=c(min(as.numeric(as.character(est[[i]]$temp))),max(as.numeric(as.character(est[[i]]$temp)))+1),type="n",yaxt="n",ylab="",
     xlab=xlab,frame.plot=F)
abline(v=mft[i],lty=1, col="blue")
abline(v=quantile(villes_s[[i]]$tempmoy,c(0.1,0.75,0.90)),lty=2)
}
layout(matrix(1:8,ncol=2),heights=c(0.8,rep(0.2,2),0.20,0.8,rep(0.2,2),0.20))
for (i in 3:4){
par(mar=c(0.2,5,2,1),las=1,cex.axis=0.8,cex.lab=1)
plot(pred[[i]],"overall",col="red",xlim=c(min(as.numeric(as.character(est[[i]]$temp))),max(as.numeric(as.character(est[[i]]$temp)))+1),ylim=c(0.5,2.5),axes=F,xlab="", ylab="RR",main=names(villes_s)[i])
abline(v=mft[i],lty=1, col="blue")
abline(v=quantile(villes_s[[i]]$tempmoy,c(0.1,0.75,0.90)),lty=2)
axis(2,at=c(0,round(max(pred[[i]]$allRRfit)*(1/5),digits =2),round(max(pred[[i]]$allRRfit)*(2/5),digits=2),round(max(pred[[i]]$allRRfit)*(3/5),digits = 2),round(max(pred[[i]]$allRRfit)*(4/5),digits=2),round(max(pred[[i]]$allRRfit),digits=2),2))
par(mar=c(0.1,5,0.3,1))
hist(villes_s[[i]]$tempmoy,axes=F,col=grey(0.95),ylab="temp\nfrequency",main="",breaks=nrow(est[[i]]))
abline(v=mft[i],lty=1, col="blue")
abline(v=quantile(villes_s[[i]]$tempmoy,c(0.1,0.75,0.90)),lty=2)
axis(2,at=0:4*100)
par(mar=c(0.1,5,0.2,1))
barplot(height=est[[i]]$MAH,names=est[[i]]$temp,space=0,ylim=c(0,max(est[[i]]$MAH)),ylab="number\nof death",axes=FALSE,axisnames=FALSE,col=grey(0.95))
axis(2,at=c(0,round(max(est[[i]]$MAH)/3),round(max(est[[i]]$MAH)/2),round(max(est[[i]]$MAH)*(2/3)),max(est[[i]]$MAH)))
par(mar=c(4,5,0,1))
plot(pred[[i]]$predvar,rep(0,length(pred[[i]]$predvar)),xlim=c(min(as.numeric(as.character(est[[i]]$temp))),max(as.numeric(as.character(est[[i]]$temp)))+1),type="n",yaxt="n",ylab="",
     xlab=xlab,frame.plot=F)
abline(v=mft[i],lty=1, col="blue")
abline(v=quantile(villes_s[[i]]$tempmoy,c(0.1,0.75,0.90)),lty=2)
}
layout(matrix(1:8,ncol=2),heights=c(0.8,rep(0.2,2),0.20,0.8,rep(0.2,2),0.20))
for (i in 5:6){
par(mar=c(0.2,5,2,1),las=1,cex.axis=0.8,cex.lab=1)
plot(pred[[i]],"overall",col="red",xlim=c(min(as.numeric(as.character(est[[i]]$temp))),max(as.numeric(as.character(est[[i]]$temp)))+1),ylim=c(0.5,2.5),axes=F,xlab="", ylab="RR",main=names(villes_s)[i])
abline(v=mft[i],lty=1, col="blue")
abline(v=quantile(villes_s[[i]]$tempmoy,c(0.1,0.75,0.90)),lty=2)
axis(2,at=c(0,round(max(pred[[i]]$allRRfit)*(1/5),digits =2),round(max(pred[[i]]$allRRfit)*(2/5),digits=2),round(max(pred[[i]]$allRRfit)*(3/5),digits = 2),round(max(pred[[i]]$allRRfit)*(4/5),digits=2),round(max(pred[[i]]$allRRfit),digits=2),2))
par(mar=c(0.1,5,0.3,1))
hist(villes_s[[i]]$tempmoy,axes=F,col=grey(0.95),ylab="temp\nfrequency",main="",breaks=nrow(est[[i]]))
abline(v=mft[i],lty=1, col="blue")
abline(v=quantile(villes_s[[i]]$tempmoy,c(0.1,0.75,0.90)),lty=2)
axis(2,at=0:4*100)
par(mar=c(0.1,5,0.2,1))
barplot(height=est[[i]]$MAH,names=est[[i]]$temp,space=0,ylim=c(0,max(est[[i]]$MAH)),ylab="number\nof death",axes=FALSE,axisnames=FALSE,col=grey(0.95))
axis(2,at=c(0,round(max(est[[i]]$MAH)/3),round(max(est[[i]]$MAH)/2),round(max(est[[i]]$MAH)*(2/3)),max(est[[i]]$MAH)))
par(mar=c(4,5,0,1))
plot(pred[[i]]$predvar,rep(0,length(pred[[i]]$predvar)),xlim=c(min(as.numeric(as.character(est[[i]]$temp))),max(as.numeric(as.character(est[[i]]$temp)))+1),type="n",yaxt="n",ylab="",
     xlab=xlab,frame.plot=F)
abline(v=mft[i],lty=1, col="blue")
abline(v=quantile(villes_s[[i]]$tempmoy,c(0.1,0.75,0.90)),lty=2)
}
layout(matrix(1:8,ncol=2),heights=c(0.8,rep(0.2,2),0.20,0.8,rep(0.2,2),0.20))
for (i in 7:8){
par(mar=c(0.2,5,2,1),las=1,cex.axis=0.8,cex.lab=1)
plot(pred[[i]],"overall",col="red",xlim=c(min(as.numeric(as.character(est[[i]]$temp))),max(as.numeric(as.character(est[[i]]$temp)))+1),ylim=c(0.5,2.5),axes=F,xlab="", ylab="RR",main=names(villes_s)[i])
abline(v=mft[i],lty=1, col="blue")
abline(v=quantile(villes_s[[i]]$tempmoy,c(0.1,0.75,0.90)),lty=2)
axis(2,at=c(0,round(max(pred[[i]]$allRRfit)*(1/5),digits =2),round(max(pred[[i]]$allRRfit)*(2/5),digits=2),round(max(pred[[i]]$allRRfit)*(3/5),digits = 2),round(max(pred[[i]]$allRRfit)*(4/5),digits=2),round(max(pred[[i]]$allRRfit),digits=2),2))
par(mar=c(0.1,5,0.3,1))
hist(villes_s[[i]]$tempmoy,axes=F,col=grey(0.95),ylab="temp\nfrequency",main="",breaks=nrow(est[[i]]))
abline(v=mft[i],lty=1, col="blue")
abline(v=quantile(villes_s[[i]]$tempmoy,c(0.1,0.75,0.90), na.rm = TRUE),lty=2)
axis(2,at=0:4*100)
par(mar=c(0.1,5,0.2,1))
barplot(height=est[[i]]$MAH,names=est[[i]]$temp,space=0,ylim=c(0,max(est[[i]]$MAH)),ylab="number\nof death",axes=FALSE,axisnames=FALSE,col=grey(0.95))
axis(2,at=c(0,round(max(est[[i]]$MAH)/3),round(max(est[[i]]$MAH)/2),round(max(est[[i]]$MAH)*(2/3)),max(est[[i]]$MAH)))
par(mar=c(4,5,0,1))
plot(pred[[i]]$predvar,rep(0,length(pred[[i]]$predvar)),xlim=c(min(as.numeric(as.character(est[[i]]$temp))),max(as.numeric(as.character(est[[i]]$temp)))+1),type="n",yaxt="n",ylab="",
     xlab=xlab,frame.plot=F)
abline(v=mft[i],lty=1, col="blue")
abline(v=quantile(villes_s[[i]]$tempmoy,c(0.1,0.75,0.90), na.rm = TRUE),lty=2)
}

layout(matrix(1:8,ncol=2),heights=c(0.8,rep(0.2,2),0.20,0.8,rep(0.2,2),0.20))
for (i in 9:10){
par(mar=c(0.2,5,2,1),las=1,cex.axis=0.8,cex.lab=1)
plot(pred[[i]],"overall",col="red",xlim=c(min(as.numeric(as.character(est[[i]]$temp)))-1,max(as.numeric(as.character(est[[i]]$temp)))),ylim=c(0.5,2.5),axes=F,xlab="", ylab="RR",main=names(villes_s)[i])
abline(v=mft[i],lty=1, col="blue")
abline(v=quantile(villes_s[[i]]$tempmoy,c(0.1,0.75,0.90), na.rm=TRUE),lty=2)
axis(2,at=c(0,round(max(pred[[i]]$allRRfit)*(1/5),digits =2),round(max(pred[[i]]$allRRfit)*(2/5),digits=2),round(max(pred[[i]]$allRRfit)*(3/5),digits = 2),round(max(pred[[i]]$allRRfit)*(4/5),digits=2),round(max(pred[[i]]$allRRfit),digits=2),2))
par(mar=c(0.1,5,0.3,1))
hist(villes_s[[i]]$tempmoy,axes=F,col=grey(0.95),ylab="temp\nfrequency",main="",breaks=nrow(est[[i]]))
abline(v=mft[i],lty=1, col="blue")
abline(v=quantile(villes_s[[i]]$tempmoy,c(0.1,0.75,0.90), na.rm = TRUE),lty=2)
axis(2,at=0:4*100)
par(mar=c(0.1,5,0.2,1))
barplot(height=est[[i]]$MAH,names=est[[i]]$temp,space=0,ylim=c(0,max(est[[i]]$MAH)),ylab="number\nof death",axes=FALSE,axisnames=FALSE,col=grey(0.95))
axis(2,at=c(0,round(max(est[[i]]$MAH)/3),round(max(est[[i]]$MAH)/2),round(max(est[[i]]$MAH)*(2/3)),max(est[[i]]$MAH)))
par(mar=c(4,5,0,1))
plot(pred[[i]]$predvar,rep(0,length(pred[[i]]$predvar)),xlim=c(min(as.numeric(as.character(est[[i]]$temp)))-1,max(as.numeric(as.character(est[[i]]$temp)))),type="n",yaxt="n",ylab="",
     xlab=xlab,frame.plot=F)
abline(v=mft[i],lty=1, col="blue")
abline(v=quantile(villes_s[[i]]$tempmoy,c(0.1,0.75,0.90),na.rm = TRUE),lty=2)
}

layout(matrix(1:8,ncol=2),heights=c(0.8,rep(0.2,2),0.20,0.8,rep(0.2,2),0.20))
for (i in 11:12){
par(mar=c(0.2,5,2,1),las=1,cex.axis=0.8,cex.lab=1)
plot(pred[[i]],"overall",col="red",xlim=c(min(as.numeric(as.character(est[[i]]$temp))),max(as.numeric(as.character(est[[i]]$temp)))+1),ylim=c(0.5,2.5),axes=F,xlab="", ylab="RR",main=names(villes_s)[i])
abline(v=mft[i],lty=1, col="blue")
abline(v=quantile(villes_s[[i]]$tempmoy,c(0.1,0.75,0.90)),lty=2)
axis(2,at=c(0,round(max(pred[[i]]$allRRfit)*(1/5),digits =2),round(max(pred[[i]]$allRRfit)*(2/5),digits=2),round(max(pred[[i]]$allRRfit)*(3/5),digits = 2),round(max(pred[[i]]$allRRfit)*(4/5),digits=2),round(max(pred[[i]]$allRRfit),digits=2),2))
par(mar=c(0.1,5,0.3,1))
hist(villes_s[[i]]$tempmoy,axes=F,col=grey(0.95),ylab="temp\nfrequency",main="",breaks=nrow(est[[i]]))
abline(v=mft[i],lty=1, col="blue")
abline(v=quantile(villes_s[[i]]$tempmoy,c(0.1,0.75,0.90)),lty=2)
axis(2,at=0:4*100)
par(mar=c(0.1,5,0.2,1))
barplot(height=est[[i]]$MAH,names=est[[i]]$temp,space=0,ylim=c(0,max(est[[i]]$MAH)),ylab="number\nof death",axes=FALSE,axisnames=FALSE,col=grey(0.95))
axis(2,at=c(0,round(max(est[[i]]$MAH)/3),round(max(est[[i]]$MAH)/2),round(max(est[[i]]$MAH)*(2/3)),max(est[[i]]$MAH)))
par(mar=c(4,5,0,1))
plot(pred[[i]]$predvar,rep(0,length(pred[[i]]$predvar)),xlim=c(min(as.numeric(as.character(est[[i]]$temp))),max(as.numeric(as.character(est[[i]]$temp)))+1),type="n",yaxt="n",ylab="",
     xlab=xlab,frame.plot=F)
abline(v=mft[i],lty=1, col="blue")
abline(v=quantile(villes_s[[i]]$tempmoy,c(0.1,0.75,0.90)),lty=2)
}

layout(matrix(1:8,ncol=2),heights=c(0.8,rep(0.2,2),0.20,0.8,rep(0.2,2),0.20))
for (i in 13:14){
par(mar=c(0.2,5,2,1),las=1,cex.axis=0.8,cex.lab=1)
plot(pred[[i]],"overall",col="red",xlim=c(min(as.numeric(as.character(est[[i]]$temp))),max(as.numeric(as.character(est[[i]]$temp)))+1),ylim=c(0.5,2.5),axes=F,xlab="", ylab="RR",main=names(villes_s)[i])
abline(v=mft[i],lty=1, col="blue")
abline(v=quantile(villes_s[[i]]$tempmoy,c(0.1,0.75,0.90)),lty=2)
axis(2,at=c(0,round(max(pred[[i]]$allRRfit)*(1/5),digits =2),round(max(pred[[i]]$allRRfit)*(2/5),digits=2),round(max(pred[[i]]$allRRfit)*(3/5),digits = 2),round(max(pred[[i]]$allRRfit)*(4/5),digits=2),round(max(pred[[i]]$allRRfit),digits=2),2))
par(mar=c(0.1,5,0.3,1))
hist(villes_s[[i]]$tempmoy,axes=F,col=grey(0.95),ylab="temp\nfrequency",main="",breaks=nrow(est[[i]]))
abline(v=mft[i],lty=1, col="blue")
abline(v=quantile(villes_s[[i]]$tempmoy,c(0.1,0.75,0.90)),lty=2)
axis(2,at=0:4*100)
par(mar=c(0.1,5,0.2,1))
barplot(height=est[[i]]$MAH,names=est[[i]]$temp,space=0,ylim=c(0,max(est[[i]]$MAH)),ylab="number\nof death",axes=FALSE,axisnames=FALSE,col=grey(0.95))
axis(2,at=c(0,round(max(est[[i]]$MAH)/3),round(max(est[[i]]$MAH)/2),round(max(est[[i]]$MAH)*(2/3)),max(est[[i]]$MAH)))
par(mar=c(4,5,0,1))
plot(pred[[i]]$predvar,rep(0,length(pred[[i]]$predvar)),xlim=c(min(as.numeric(as.character(est[[i]]$temp))),max(as.numeric(as.character(est[[i]]$temp)))+1),type="n",yaxt="n",ylab="",
     xlab=xlab,frame.plot=F)
abline(v=mft[i],lty=1, col="blue")
abline(v=quantile(villes_s[[i]]$tempmoy,c(0.1,0.75,0.90)),lty=2)
}

layout(matrix(1:8,ncol=2),heights=c(0.8,rep(0.2,2),0.20,0.8,rep(0.2,2),0.20))
for (i in 15:16){
par(mar=c(0.2,5,2,1),las=1,cex.axis=0.8,cex.lab=1)
plot(pred[[i]],"overall",col="red",xlim=c(min(as.numeric(as.character(est[[i]]$temp))),max(as.numeric(as.character(est[[i]]$temp)))+1),ylim=c(0.5,2.5),axes=F,xlab="", ylab="RR",main=names(villes_s)[i])
abline(v=mft[i],lty=1, col="blue")
abline(v=quantile(villes_s[[i]]$tempmoy,c(0.1,0.75,0.90)),lty=2)
axis(2,at=c(0,round(max(pred[[i]]$allRRfit)*(1/5),digits =2),round(max(pred[[i]]$allRRfit)*(2/5),digits=2),round(max(pred[[i]]$allRRfit)*(3/5),digits = 2),round(max(pred[[i]]$allRRfit)*(4/5),digits=2),round(max(pred[[i]]$allRRfit),digits=2),2))
par(mar=c(0.1,5,0.3,1))
hist(villes_s[[i]]$tempmoy,axes=F,col=grey(0.95),ylab="temp\nfrequency",main="",breaks=nrow(est[[i]]))
abline(v=mft[i],lty=1, col="blue")
abline(v=quantile(villes_s[[i]]$tempmoy,c(0.1,0.75,0.90)),lty=2)
axis(2,at=0:4*100)
par(mar=c(0.1,5,0.2,1))
barplot(height=est[[i]]$MAH,names=est[[i]]$temp,space=0,ylim=c(0,max(est[[i]]$MAH)),ylab="number\nof death",axes=FALSE,axisnames=FALSE,col=grey(0.95))
axis(2,at=c(0,round(max(est[[i]]$MAH)/3),round(max(est[[i]]$MAH)/2),round(max(est[[i]]$MAH)*(2/3)),max(est[[i]]$MAH)))
par(mar=c(4,5,0,1))
plot(pred[[i]]$predvar,rep(0,length(pred[[i]]$predvar)),xlim=c(min(as.numeric(as.character(est[[i]]$temp))),max(as.numeric(as.character(est[[i]]$temp)))+1),type="n",yaxt="n",ylab="",
     xlab=xlab,frame.plot=F)
abline(v=mft[i],lty=1, col="blue")
abline(v=quantile(villes_s[[i]]$tempmoy,c(0.1,0.75,0.90)),lty=2)
}

layout(matrix(1:8,ncol=2),heights=c(0.8,rep(0.2,2),0.20,0.8,rep(0.2,2),0.20))
for (i in 17:18){
par(mar=c(0.2,5,2,1),las=1,cex.axis=0.8,cex.lab=1)
plot(pred[[i]],"overall",col="red",xlim=c(min(as.numeric(as.character(est[[i]]$temp))),max(as.numeric(as.character(est[[i]]$temp)))+1),ylim=c(0.5,2.5),axes=F,xlab="", ylab="RR",main=names(villes_s)[i])
abline(v=mft[i],lty=1, col="blue")
abline(v=quantile(villes_s[[i]]$tempmoy,c(0.1,0.75,0.90)),lty=2)
axis(2,at=c(0,round(max(pred[[i]]$allRRfit)*(1/5),digits =2),round(max(pred[[i]]$allRRfit)*(2/5),digits=2),round(max(pred[[i]]$allRRfit)*(3/5),digits = 2),round(max(pred[[i]]$allRRfit)*(4/5),digits=2),round(max(pred[[i]]$allRRfit),digits=2),2))
par(mar=c(0.1,5,0.3,1))
hist(villes_s[[i]]$tempmoy,axes=F,col=grey(0.95),ylab="temp\nfrequency",main="",breaks=nrow(est[[i]]))
abline(v=mft[i],lty=1, col="blue")
abline(v=quantile(villes_s[[i]]$tempmoy,c(0.1,0.75,0.90)),lty=2)
axis(2,at=0:4*100)
par(mar=c(0.1,5,0.2,1))
barplot(height=est[[i]]$MAH,names=est[[i]]$temp,space=0,ylim=c(0,max(est[[i]]$MAH)),ylab="number\nof death",axes=FALSE,axisnames=FALSE,col=grey(0.95))
axis(2,at=c(0,round(max(est[[i]]$MAH)/3),round(max(est[[i]]$MAH)/2),round(max(est[[i]]$MAH)*(2/3)),max(est[[i]]$MAH)))
par(mar=c(4,5,0,1))
plot(pred[[i]]$predvar,rep(0,length(pred[[i]]$predvar)),xlim=c(min(as.numeric(as.character(est[[i]]$temp))),max(as.numeric(as.character(est[[i]]$temp)))+1),type="n",yaxt="n",ylab="",
     xlab=xlab,frame.plot=F)
abline(v=mft[i],lty=1, col="blue")
abline(v=quantile(villes_s[[i]]$tempmoy,c(0.1,0.75,0.90)),lty=2)
}

layout(matrix(1:8,ncol=2),heights=c(0.8,rep(0.2,2),0.20,0.8,rep(0.2,2),0.20))
for (i in 19:20){
par(mar=c(0.2,5,2,1),las=1,cex.axis=0.8,cex.lab=1)
plot(pred[[i]],"overall",col="red",xlim=c(min(as.numeric(as.character(est[[i]]$temp))),max(as.numeric(as.character(est[[i]]$temp)))+1),ylim=c(0.5,2.5),axes=F,xlab="", ylab="RR",main=names(villes_s)[i])
abline(v=mft[i],lty=1, col="blue")
abline(v=quantile(villes_s[[i]]$tempmoy,c(0.1,0.75,0.90)),lty=2)
axis(2,at=c(0,round(max(pred[[i]]$allRRfit)*(1/5),digits =2),round(max(pred[[i]]$allRRfit)*(2/5),digits=2),round(max(pred[[i]]$allRRfit)*(3/5),digits = 2),round(max(pred[[i]]$allRRfit)*(4/5),digits=2),round(max(pred[[i]]$allRRfit),digits=2),2))
par(mar=c(0.1,5,0.3,1))
hist(villes_s[[i]]$tempmoy,axes=F,col=grey(0.95),ylab="temp\nfrequency",main="",breaks=nrow(est[[i]]))
abline(v=mft[i],lty=1, col="blue")
abline(v=quantile(villes_s[[i]]$tempmoy,c(0.1,0.75,0.90)),lty=2)
axis(2,at=0:4*100)
par(mar=c(0.1,5,0.2,1))
barplot(height=est[[i]]$MAH,names=est[[i]]$temp,space=0,ylim=c(0,max(est[[i]]$MAH)),ylab="number\nof death",axes=FALSE,axisnames=FALSE,col=grey(0.95))
axis(2,at=c(0,round(max(est[[i]]$MAH)/3),round(max(est[[i]]$MAH)/2),round(max(est[[i]]$MAH)*(2/3)),max(est[[i]]$MAH)))
par(mar=c(4,5,0,1))
plot(pred[[i]]$predvar,rep(0,length(pred[[i]]$predvar)),xlim=c(min(as.numeric(as.character(est[[i]]$temp))),max(as.numeric(as.character(est[[i]]$temp)))+1),type="n",yaxt="n",ylab="",
     xlab=xlab,frame.plot=F)
abline(v=mft[i],lty=1, col="blue")
abline(v=quantile(villes_s[[i]]$tempmoy,c(0.1,0.75,0.90)),lty=2)
}

layout(matrix(1:4,ncol=1),heights=c(0.8,rep(0.2,2),0.20))
i=21
par(mar=c(0.2,5,2,1),las=1,cex.axis=0.8,cex.lab=1)
plot(pred[[i]],"overall",col="red",xlim=c(min(as.numeric(as.character(est[[i]]$temp)))-1,max(as.numeric(as.character(est[[i]]$temp)))),ylim=c(0.5,2.5),axes=F,xlab="", ylab="RR",main=names(villes_s)[i])
abline(v=mft[i],lty=1, col="blue")
abline(v=quantile(villes_s[[i]]$tempmoy,c(0.1,0.75,0.90)),lty=2)
axis(2,at=c(0,round(max(pred[[i]]$allRRfit)*(1/5),digits =2),round(max(pred[[i]]$allRRfit)*(2/5),digits=2),round(max(pred[[i]]$allRRfit)*(3/5),digits = 2),round(max(pred[[i]]$allRRfit)*(4/5),digits=2),round(max(pred[[i]]$allRRfit),digits=2),2))
par(mar=c(0.1,5,0.3,1))
hist(villes_s[[i]]$tempmoy,axes=F,col=grey(0.95),ylab="temp\nfrequency",main="",breaks=nrow(est[[i]]))
abline(v=mft[i],lty=1, col="blue")
abline(v=quantile(villes_s[[i]]$tempmoy,c(0.1,0.75,0.90)),lty=2)
axis(2,at=0:4*100)
par(mar=c(0.1,5,0.2,1))
barplot(height=est[[i]]$MAH,names=est[[i]]$temp,space=0,ylim=c(0,max(est[[i]]$MAH)),ylab="number\nof death",axes=FALSE,axisnames=FALSE,col=grey(0.95))
axis(2,at=c(0,round(max(est[[i]]$MAH)/3),round(max(est[[i]]$MAH)/2),round(max(est[[i]]$MAH)*(2/3)),max(est[[i]]$MAH)))
par(mar=c(4,5,0,1))
plot(pred[[i]]$predvar,rep(0,length(pred[[i]]$predvar)),xlim=c(min(as.numeric(as.character(est[[i]]$temp)))-1,max(as.numeric(as.character(est[[i]]$temp)))),type="n",yaxt="n",ylab="",
     xlab=xlab,frame.plot=F)
abline(v=mft[i],lty=1, col="blue")
abline(v=quantile(villes_s[[i]]$tempmoy,c(0.1,0.75,0.90)),lty=2)


```

### PLOT 3 - LAG EFFECT

```{r}
val<-lapply(villes_s,function(x){round(quantile(x$tempmoy,0.975, na.rm=TRUE))})

layout(matrix(1:4,ncol=2))
for (i in 1:4){
  par(cex.main=0.8)
  tit<-paste("Association for HW initial threshold value (",val[[i]],"°C) in",names(villes_s)[i])
  plot(pred[[1]], var=val[[i]], col=3, ylab="RR", main=tit)
}
layout(matrix(1:4,ncol=2))
for (i in 5:8){
  par(cex.main=0.8)
  tit<-paste("Association for HW initial threshold value (",val[[i]],"°C) in",names(villes_s)[i])
  plot(pred[[1]], var=val[[i]], col=3, ylab="RR", main=tit)
}
layout(matrix(1:4,ncol=2))
for (i in 9:12){
  par(cex.main=0.8)
  tit<-paste("Association for HW initial threshold value (",val[[i]],"°C) in",names(villes_s)[i])
  plot(pred[[1]], var=val[[i]], col=3, ylab="RR", main=tit)
}
layout(matrix(1:4,ncol=2))
for (i in 13:16){
  par(cex.main=0.8)
  tit<-paste("Association for HW initial threshold value (",val[[i]],"°C) in",names(villes_s)[i])
  plot(pred[[1]], var=val[[i]], col=3, ylab="RR", main=tit)
}
layout(matrix(1:4,ncol=2))
for (i in 17:20){
  par(cex.main=0.8)
  tit<-paste("Association for HW initial threshold value (",val[[i]],"°C) in",names(villes_s)[i])
  plot(pred[[1]], var=val[[i]], col=3, ylab="RR", main=tit)
}
i=21
tit<-paste("Association for HW initial threshold value (",val[[i]],"°C) in",names(villes_s)[i])
  plot(pred[[1]], var=val[[i]], col=3, ylab="RR", main=tit)
```



## 2. FIRST STAGE ANALYSIS: Estimation of the exposure-response associations at city level for 2 periods of the summer

I decided to exclude the months of may and September, when extreme heat event never happen in France. 
Then I define two periods of the summer:  
- 1st part of the summer: 1st of june until 15th of July
- 2nd part of the summer: From 16th of July until end of August


```{r}

# Create an database for each period
summer1<-list()
summer2<-list()


for (i in 1:length(villes_s)){
  summer1[[i]]<-villes_s[[i]][which(villes_s[[i]]$day > 31 & villes_s[[i]]$day<77),]
  summer1[[i]]$time<-1:nrow(summer1[[i]])
  summer2[[i]]<-villes_s[[i]][which(villes_s[[i]]$day > 76 & villes_s[[i]]$day<124),]
  summer2[[i]]$time<-1:nrow(summer2[[i]])
  }

names(summer1)<-names(villes_s)
names(summer2)<-names(villes_s)

```


#### Defintion of the cross-basis function (with its two dimensions) for the temperature of each month:

```{r}
# 1. SPECIFICATION PARAMETERS OF THE EXPOSURE-RESPONSE DIMENSION OF THE CROSS-BASIS

argvar_summer<-list()

for (i in 1: length(villes_s)){
argvar_summer[[i]] <- list(fun="ns", knots = quantile(villes_s[[i]]$tempmoy,c(10,75,90)/100, na.rm=T),
  Bound=range(villes_s[[i]]$tempmoy,na.rm=T))
}

names(argvar_summer)<-names(villes_s)

# 2. SPECIFICATION PARAMETERS OF THE LAG-ASSOCIATION DIMENSION OF THE CROSS-BASIS
# Definition of the maximum lag: I chose 7 days
maxlag <- 7

arglag <- list(fun="ns",knots=logknots(maxlag,nk=3))

# - CREATE CROSSBASIS OBJECTS
cb_summer1<-list()
cb_summer2<-list()

for (i in 1: length(villes_s)){
cb_summer1[[i]] <- crossbasis(summer1[[i]]$tempmoy,maxlag,argvar_summer[[i]],arglag, group=summer1[[i]]$year)  
cb_summer2[[i]] <- crossbasis(summer2[[i]]$tempmoy,maxlag,argvar_summer[[i]],arglag, group=summer2[[i]]$year)  
}

names(cb_summer1)<-names(villes_s)
names(cb_summer2)<-names(villes_s)
```

#### Fit the models for each city and each period for RESPIRATORY DEATHS
Include in the models the crossbasis term of temperature, along with the indicator for day of the week (Jours), bank holidays (Vacances) and natural cubic spline of time with 8 df per year.

```{r}
mod_summer1<-list()
mod_summer2<-list()

for (i in 1: length(villes_s)){
cb_func1<-cb_summer1[[i]]
mod_summer1[[i]] <- glm(respi_tot ~ cb_func1 + Jours + ns(day, 4) + ns(time,3), data=summer1[[i]], family=quasipoisson)
cb_func2<-cb_summer2[[i]]
mod_summer2[[i]] <- glm(respi_tot ~ cb_func2 + Jours + ns(day, 4) + ns(time,3), data=summer2[[i]], family=quasipoisson)
}

```

We get predictions for each model centering on mft value:

```{r}
pred_summer1<-list()
pred_summer2<-list()

for (i in 1: length(villes_s)){
  pred_summer1[[i]] <- crosspred(cb_func1, mod_summer1[[i]],cen=mft[[i]], by=1)
  pred_summer2[[i]] <- crosspred(cb_func2, mod_summer2[[i]],cen=mft[[i]], by=1)
  }
```


### PLOT 3 - OVERALL WITH DIFFERENT FUNCTION FOR EACH MONTH

we compare the different shapes of the cumulative exposure-response association (in terms of relative risks (RR) and centered in the mft) across the 7 days of lag, estimated for each month of the summer

```{r, echo = FALSE}
layout(matrix(c(1,2,3,4,5,6),ncol=3,nrow=2,byrow=T))
par(mar=c(5,4,3,1),mgp=c(3,1,0),las=1,cex.axis=0.9,cex.lab=1)
plot(pred_summer1[[1]],"overall",col="blue",axes=T,lab=c(6,5,7), xlab=xlab,
  ylim=c(0,10), ylab="RR", ci.arg=list(density=20,angle=-45,col=4), main=names(villes_s)[1])
lines(pred_summer2[[1]], col="red", ci="area", ci.arg=list(density=20,col=2))
legend("topleft",c("First Period","Second Period")
  ,xpd = TRUE,col=c("blue","red"),lwd=2,bg="white"
  ,cex=0.7,ncol=1,inset=0.01,bty="n")
plot(pred_summer1[[2]],"overall",col="blue",axes=T,lab=c(6,5,7), xlab=xlab,
  ylim=c(0,10), ylab="RR", ci.arg=list(density=20,angle=-45,col=4), main=names(villes_s)[2])
lines(pred_summer2[[2]], col="red", ci="area", ci.arg=list(density=20,col=2))
legend("topleft",c("First Period","Second Period")
  ,xpd = TRUE,col=c("blue","red"),lwd=2,bg="white"
  ,cex=0.7,ncol=1,inset=0.01,bty="n")
plot(pred_summer1[[3]],"overall",col="blue",axes=T,lab=c(6,5,7), xlab=xlab,ylim=c(0.5,3),
  ylab="RR", ci.arg=list(density=20,angle=-45,col=4), main=names(villes_s)[3])
lines(pred_summer2[[3]], col="red", ci="area", ci.arg=list(density=20,col=2))
legend("topleft",c("First Period","Second Period")
  ,xpd = TRUE,col=c("blue","red"),lwd=2,bg="white"
  ,cex=0.7,ncol=1,inset=0.01,bty="n")
for (i in 4:6){
plot(pred_summer1[[i]],"overall",col="blue",axes=T,lab=c(6,5,7), xlab=xlab,
  ylim=c(0,5),ylab="RR", ci.arg=list(density=20,angle=-45,col=4), main=names(villes_s)[i])
lines(pred_summer2[[i]], col="red", ci="area", ci.arg=list(density=20,col=2))
legend("topleft",c("First Period","Second Period")
  ,xpd = TRUE,col=c("blue","red"),lwd=2,bg="white"
  ,cex=0.7,ncol=1,inset=0.01,bty="n")
}

layout(matrix(c(1,2,3,4,5,6),ncol=3,nrow=2,byrow=T))
par(mar=c(5,4,3,1),mgp=c(3,1,0),las=1,cex.axis=0.9,cex.lab=1)
plot(pred_summer1[[7]],"overall",col="blue",axes=T,lab=c(6,5,7), ylim=c(0,4), xlab=xlab,
  ylab="RR", ci.arg=list(density=20,angle=-45,col=4), main=names(villes_s)[7])
lines(pred_summer2[[7]], col="red", ci="area", ci.arg=list(density=20,col=2))
legend("topleft",c("First Period","Second Period")
  ,xpd = TRUE,col=c("blue","red"),lwd=2,bg="white"
  ,cex=0.7,ncol=1,inset=0.01,bty="n")
for (i in 8:10){
#par(mar=c(5,4,3,1),mgp=c(3,1,0),las=1,cex.axis=0.9,cex.lab=1)
plot(pred_summer1[[i]],"overall",col="blue",axes=T,lab=c(6,5,7), xlab=xlab,
  ylim=c(0,3),ylab="RR", ci.arg=list(density=20,angle=-45,col=4), main=names(villes_s)[i])
lines(pred_summer2[[i]], col="red", ci="area", ci.arg=list(density=20,col=2))
legend("topleft",c("First Period","Second Period")
  ,xpd = TRUE,col=c("blue","red"),lwd=2,bg="white"
  ,cex=0.7,ncol=1,inset=0.01,bty="n")
}

par(mar=c(5,4,3,1),mgp=c(3,1,0),las=1,cex.axis=0.9,cex.lab=1)
plot(pred_summer1[[11]],"overall",col="blue",axes=T,lab=c(6,5,7),xlab=xlab,
  ylim=c(0,5),ylab="RR", ci.arg=list(density=20,angle=-45,col=4), main=names(villes_s)[11])
lines(pred_summer2[[11]], col="red", ci="area", ci.arg=list(density=20,col=2))
legend("topleft",c("First Period","Second Period")
  ,xpd = TRUE,col=c("blue","red"),lwd=2,bg="white"
  ,cex=0.7,ncol=1,inset=0.01,bty="n")
par(mar=c(5,4,3,1),mgp=c(3,1,0),las=1,cex.axis=0.9,cex.lab=1)
plot(pred_summer1[[12]],"overall",col="blue",axes=T,lab=c(6,5,7),xlab=xlab,
  ylim=c(0,4),ylab="RR", ci.arg=list(density=20,angle=-45,col=4), main=names(villes_s)[12])
lines(pred_summer2[[12]], col="red", ci="area", ci.arg=list(density=20,col=2))
legend("topleft",c("First Period","Second Period")
  ,xpd = TRUE,col=c("blue","red"),lwd=2,bg="white"
  ,cex=0.7,ncol=1,inset=0.01,bty="n")

layout(matrix(c(1,2,3,4,5,6),ncol=3,nrow=2,byrow=T))
par(mar=c(5,4,3,1),mgp=c(3,1,0),las=1,cex.axis=0.9,cex.lab=1)
plot(pred_summer1[[13]],"overall",col="blue",axes=T,lab=c(6,5,7),xlab=xlab,
  ylab="RR", ci.arg=list(density=20,angle=-45,col=4), main=names(villes_s)[13])
lines(pred_summer2[[13]], col="red", ci="area", ci.arg=list(density=20,col=2))
legend("topleft",c("First Period","Second Period")
  ,xpd = TRUE,col=c("blue","red"),lwd=2,bg="white"
  ,cex=0.7,ncol=1,inset=0.01,bty="n")
par(mar=c(5,4,3,1),mgp=c(3,1,0),las=1,cex.axis=0.9,cex.lab=1)
plot(pred_summer1[[14]],"overall",col="blue",axes=T,lab=c(6,5,7),xlab=xlab,
  ylim=c(0, 5),ylab="RR", ci.arg=list(density=20,angle=-45,col=4), main=names(villes_s)[14])
lines(pred_summer2[[14]], col="red", ci="area", ci.arg=list(density=20,col=2))
legend("topleft",c("First Period","Second Period")
  ,xpd = TRUE,col=c("blue","red"),lwd=2,bg="white"
  ,cex=0.7,ncol=1,inset=0.01,bty="n")

par(mar=c(5,4,3,1),mgp=c(3,1,0),las=1,cex.axis=0.9,cex.lab=1)
plot(pred_summer1[[15]],"overall",col="blue",axes=T,lab=c(6,5,7),xlab=xlab,
  ylab="RR", ci.arg=list(density=20,angle=-45,col=4), main=names(villes_s)[15])
lines(pred_summer2[[15]], col="red", ci="area", ci.arg=list(density=20,col=2))
legend("topleft",c("First Period","Second Period")
  ,xpd = TRUE,col=c("blue","red"),lwd=2,bg="white"
  ,cex=0.7,ncol=1,inset=0.01,bty="n")

par(mar=c(5,4,3,1),mgp=c(3,1,0),las=1,cex.axis=0.9,cex.lab=1)
plot(pred_summer1[[16]],"overall",col="blue",axes=T,lab=c(6,5,7),xlab=xlab,
  ylim=c(0,6), ylab="RR", ci.arg=list(density=20,angle=-45,col=4), main=names(villes_s)[16])
lines(pred_summer2[[16]], col="red", ci="area", ci.arg=list(density=20,col=2))
legend("topleft",c("First Period","Second Period")
  ,xpd = TRUE,col=c("blue","red"),lwd=2,bg="white"
  ,cex=0.7,ncol=1,inset=0.01,bty="n")

par(mar=c(5,4,3,1),mgp=c(3,1,0),las=1,cex.axis=0.9,cex.lab=1)
plot(pred_summer1[[17]],"overall",col="blue",axes=T,lab=c(6,5,7),xlab=xlab,
  ylim=c(0,5), ylab="RR", ci.arg=list(density=20,angle=-45,col=4), main=names(villes_s)[17])
lines(pred_summer2[[17]], col="red", ci="area", ci.arg=list(density=20,col=2))
legend("topleft",c("First Period","Second Period")
  ,xpd = TRUE,col=c("blue","red"),lwd=2,bg="white"
  ,cex=0.7,ncol=1,inset=0.01,bty="n")

par(mar=c(5,4,3,1),mgp=c(3,1,0),las=1,cex.axis=0.9,cex.lab=1)
plot(pred_summer1[[18]],"overall",col="blue",axes=T,lab=c(6,5,7),xlab=xlab,
  ylab="RR", ci.arg=list(density=20,angle=-45,col=4), main=names(villes_s)[18])
lines(pred_summer2[[18]], col="red", ci="area", ci.arg=list(density=20,col=2))
legend("topleft",c("First Period","Second Period")
  ,xpd = TRUE,col=c("blue","red"),lwd=2,bg="white"
  ,cex=0.7,ncol=1,inset=0.01,bty="n")

layout(matrix(c(1,2,3,4,5,6),ncol=3,nrow=2,byrow=T))
for (i in 19:20){
par(mar=c(5,4,3,1),mgp=c(3,1,0),las=1,cex.axis=0.9,cex.lab=1)
plot(pred_summer1[[i]],"overall",col="blue",axes=T,lab=c(6,5,7),xlab=xlab,
  ylab="RR", main=names(villes_s)[i], ci.arg=list(density=20,angle=-45,col=4))
lines(pred_summer2[[i]], col="red", ci="area", ci.arg=list(density=20,col=2))
legend("topleft",c("First Period","Second Period")
  ,xpd = TRUE,col=c("blue","red"),lwd=2,bg="white"
  ,cex=0.7,ncol=1,inset=0.01,bty="n")
}
par(mar=c(5,4,3,1),mgp=c(3,1,0),las=1,cex.axis=0.9,cex.lab=1)
plot(pred_summer1[[21]],"overall",col="blue",axes=T,lab=c(6,5,7),xlab=xlab,
  ylim=c(0,5), ylab="RR", main=names(villes_s)[21], ci.arg=list(density=20,angle=-45,col=4))
lines(pred_summer2[[21]], col="red", ci="area", ci.arg=list(density=20,col=2))
legend("topleft",c("First Period","Second Period")
  ,xpd = TRUE,col=c("blue","red"),lwd=2,bg="white"
  ,cex=0.7,ncol=1,inset=0.01,bty="n")

```


The set of 20 coefficients of the cross-basis in each city are then reduced. We reduce the fit of a bi-dimensional DLNM to summaries expressed by parameters of one-dimensional basis. 

```{r}
####################################################################
# BUILT OBJECTS WHERE RESULTS WILL BE STORED
#   y- IS THE MATRIX FOR THE OUTCOME PARAMETERS
#   S- IS THE LISTS OF (CO)VARIANCE MATRICES

# OVERALL CUMULATIVE SUMMARIES
yall1 <- matrix(NA,length(villes_s),4,dimnames=list(names(villes_s),paste("b",seq(4),sep="")))
yall2 <- matrix(NA,length(villes_s),4,dimnames=list(names(villes_s),paste("b",seq(4),sep="")))

# (CO)VARIANCE MATRICES
cov1 <- vector("list",length(villes_s))
cov2 <- vector("list",length(villes_s))

names(cov1)<-names(cov2) <- names(villes_s)




for (i in 1: length(villes_s)){
    cb_func1<-cb_summer1[[i]]
    red_par1 <- crossreduce(cb_func1,mod_summer1[[i]], cen=mft[[i]])
    yall1[i,] <- coef(red_par1)  #I STORE THE RESULTS for the OVERALL CUMULATIVE SUMMARY FOR THE MAIN MODEL
    cov1[[i]] <- vcov(red_par1)  # I store the covariance matrix
    cb_func2<-cb_summer2[[i]]
    red_par2 <- crossreduce(cb_func2,mod_summer2[[i]], cen=mft[[i]])
    yall2[i,] <- coef(red_par2)
    cov2[[i]] <- vcov(red_par2)
    }




```

For each city we derive the vector with 4 reduced parameters of the natural spline of temperature for the overall cumulative summary association. 


## 3. Second stage analysis to obtain pooled estimates

In the second stage analysis, we: 
- RUN THE MULTIVARIATE META-ANALYTICAL MODELS WITH mvmeta
- CREATE BASIS VARIABLES USING onebasis, TO BE USED FOR PREDICTION
- OBTAIN PREDICTIONS THROUGH crosspred (dlnm)

```{r}
library(mvmeta)

# OVERALL CUMULATIVE SUMMARY FOR THE MAIN MODEL
mvall1 <- mvmeta(yall1,cov1, method="ml")
mvall2 <- mvmeta(yall2,cov2,method="ml")

summary(mvall1)
summary(mvall2)
```


```{r}
# CREATE BASES FOR PREDICTION

# BASES OF TEMPERATURE AND LAG USED TO PREDICT, EQUAL TO THAT USED FOR ESTIMATION
# COMPUTED USING THE ATTRIBUTES OF THE CROSS-BASIS USED IN ESTIMATION

x<-lapply(villes_s,function(x){x[,"tempmoy"]})
tempall<-rbind(x[["avignon"]],x[["BM"]],x[["bordeaux"]],x[["clermont"]],x[["dijon"]],x[["grenoble"]], x[["lehavre"]], x[["lille"]],x[["lyon"]],x[["marseille"]], x[["montpellier"]],x[["nancy"]],x[["nantes"]],x[["nice"]],x[["paris"]],x[["rennes"]],x[["rouen"]],x[["saint_etienne"]],x[["strasbourg"]],x[["toulon"]],x[["toulouse"]])


# minimum<-min(data.frame(lapply(villes_s,function(x){min(x$tempmoy, na.rm=TRUE)})))
# maximum<-max(data.frame(lapply(villes_s,function(x){max(x$tempmoy, na.rm=TRUE)})))

xvar <- seq(min(tempall, na.rm=TRUE),max(tempall, na.rm=TRUE),by=0.1)

bvar <- onebasis(xvar, "ns", knots = quantile(tempall,c(10,75,90)/100, na.rm=T),
  Bound=range(tempall,na.rm=T))

#bvar <- do.call("onebasis",c(list(x=xvar),attr(cb,"argvar")))

# xlag <- 1:7
# blag <- onebasis(xlag, fun="ns",knots=logknots(maxlag,nk=3))


####################################################################
# City-SPECIFIC FIRST-STAGE SUMMARIES

cityall1 <- apply(yall1,1,function(x) exp(bvar%*%x))
cityall2 <- apply(yall2,1,function(x) exp(bvar%*%x))

####################################################################
```


```{r}
# PREDICTION FOR A GRID OF TEMPERATURE AND LAG VALUES

# OVERALL CUMULATIVE SUMMARY ASSOCIATION FOR MAIN MODEL

model.class <- class(mvall1)
# coeff <- dlnm:::getcoef(mvall2,model.class)
# vcova <- dlnm:::getvcov(mvall2,model.class)
#model.link <- dlnm:::getlink(mvall1,model.class)

# test<-c(coef(mvall1)[[1]], coef(mvall1)[[2]], coef(mvall1)[[3]], coef(mvall1)[[4]])
# vcova<-matrix(ncol=4, nrow=4, dlnm:::getvcov(mvall1,model.class))

cpall1 <- crosspred(bvar, coef=dlnm:::getcoef(mvall1,model.class), vcov=dlnm:::getvcov(mvall1,model.class), model.link="log",by=0.1,from=min(tempall, na.rm=TRUE),to=max(tempall, na.rm=TRUE), cen=median(tempall, na.rm=TRUE))

cpall2 <- crosspred(bvar, coef=dlnm:::getcoef(mvall2,model.class), vcov=dlnm:::getvcov(mvall2,model.class), model.link="log",by=0.1,from=min(tempall, na.rm=TRUE),to=max(tempall, na.rm=TRUE), cen=median(tempall, na.rm=TRUE))

```

```{r}
plot(cpall1,col="blue",axes=T,lab=c(6,5,7),xlab="Temperature (C)",
  ylab="RR", ci.arg=list(density=20,angle=-45,col=4))
lines(cpall2, col="red", ci="area", ci.arg=list(density=20,col=2))
legend("topleft",c("First Period \n (I²=1.0%, X² test p-val = 0.5337)","Second Period \n (I²=39.6%, X² test p-val = 0.0002)"), horiz = TRUE
  ,xpd = TRUE,col=c("blue","red"),lwd=2,bg="white"
  ,cex=0.7,ncol=1,inset=0.01,bty="n")


```


```{r, echo=FALSE}
x<-lapply(villes_s,function(x){x[,c("tempmoy", "day")]})
x1<-list()
x2<-list()

for (i in 1:length(villes_s)){
  x1[[i]]<-x[[i]][which(x[[i]]$day > 31 & x[[i]]$day<77),]
  x2[[i]]<-x[[i]][which(x[[i]]$day > 76 & x[[i]]$day<124),]
  }

names(x1)<-names(villes_s)
names(x2)<-names(villes_s)

tempall1<-rbind(x1[["avignon"]],x1[["BM"]],x1[["bordeaux"]],x1[["clermont"]],x1[["dijon"]],x1[["grenoble"]], x1[["lehavre"]], x1[["lille"]],x1[["lyon"]],x1[["marseille"]], x1[["montpellier"]],x1[["nancy"]],x1[["nantes"]],x1[["nice"]],x1[["paris"]],x1[["rennes"]],x1[["rouen"]],x1[["saint_etienne"]],x1[["strasbourg"]],x1[["toulon"]],x1[["toulouse"]])

tempall2<-rbind(x2[["avignon"]],x2[["BM"]],x2[["bordeaux"]],x2[["clermont"]],x2[["dijon"]],x2[["grenoble"]], x2[["lehavre"]], x2[["lille"]],x2[["lyon"]],x2[["marseille"]], x2[["montpellier"]],x2[["nancy"]],x2[["nantes"]],x2[["nice"]],x2[["paris"]],x2[["rennes"]],x2[["rouen"]],x2[["saint_etienne"]],x2[["strasbourg"]],x2[["toulon"]],x2[["toulouse"]])

```


```{r, echo=FALSE, , fig.dim=c(8,8)}
layout(matrix(1:4,ncol=1),heights=c(0.8,rep(0.20,2),0.20))
par(mar=c(0.2,5,2,1),las=1,cex.axis=0.8,cex.lab=1)
plot(cpall1,col="blue",lab=c(6,5,7),xlab="Temperature (C)",
  ylab="RR", axes=F, ci.arg=list(density=20,angle=-45,col=4), xlim=c(min(xvar),max(xvar)))
lines(cpall2, col="red", ci="area", ci.arg=list(density=20,col=2), xlim=c(min(xvar),max(xvar)))
legend("topleft",c("First Period \n (I²=1.0%, X² test p-val = 0.6931)","Second Period \n (I²=74.2%, X² test p-val = 0.0000)"), horiz = TRUE
  ,xpd = TRUE,col=c("blue","red"),lwd=2,bg="white"
  ,cex=1,ncol=1,inset=0.01,bty="n")
# abline(v=mft[i],lty=1, col="blue")
# abline(v=quantile(villes_s[[i]]$tempmoy,c(0.1,0.75,0.90)),lty=2)
axis(2,at=c(0,round(max(cpall2$allRRfit)*(1/8),digits =2),round(max(cpall2$allRRfit)*(2/8),digits=2),round(max(cpall2$allRRfit)*(3/8),digits = 2),round(max(cpall2$allRRfit)*(4/8),digits=2),round(max(cpall2$allRRfit)*(5/8),digits=2), round(max(cpall2$allRRfit)*(6/8),digits=2), round(max(cpall2$allRRfit)*(7/8),digits=2),round(max(cpall2$allRRfit),digits=2),2))
par(mar=c(0.1,5,0.3,1))
hist(tempall1$tempmoy,axes=F,col=grey(0.95),ylab="Temp Freq\nFirst Period",xlim=c(min(xvar),max(xvar)),breaks=20, main="")
# abline(v=mft[i],lty=1, col="blue")
# abline(v=quantile(villes_s[[i]]$tempmoy,c(0.1,0.75,0.90)),lty=2)
axis(2,at=0:50*100)
par(mar=c(0.1,5,0.2,1))
hist(tempall2$tempmoy,axes=F,col=grey(0.95),ylab="Temp Freq\nSecond Period",xlim=c(min(xvar),max(xvar)), breaks=20, main="")
axis(2,at=0:50*100)
par(mar=c(4,1,1,1))
plot(cpall2$predvar,rep(0,length(cpall2$predvar)),type="n",yaxt="n",ylab="",xlim=c(min(xvar),max(xvar)),
     xlab="Temperature (˚C)",frame.plot=F)

```

